const { Telegraf } = require('telegraf');
const fs = require('fs');

// –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_TOKEN);

// /start ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è WebApp
bot.start((ctx) => {
  return ctx.reply(
    '–ù–∞—Ä–∏—Å—É–π —Å–≤–æ—é –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –æ—Ç–∫—Ä—ã—Ç–∫—É üéÑ',
    {
      reply_markup: {
        keyboard: [[
          {
            text: '–û—Ç–∫—Ä—ã—Ç—å —Ä–∏—Å–æ–≤–∞–ª–∫—É ‚úèÔ∏è',
            web_app: { url: 'https://–¢–í–û–ô-–î–û–ú–ï–ù/index.html' }
          }
        ]],
        resize_keyboard: true
      }
    }
  );
});

// –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp
bot.on('message', async (ctx) => {
  const webData = ctx.message.web_app_data;
  if (!webData) return;

  const dataUrl = webData.data; // "data:image/png;base64,...."
  const base64 = dataUrl.split(',')[1];
  const buffer = Buffer.from(base64, 'base64');

  await ctx.replyWithPhoto(
    { source: buffer },
    { caption: '–¢–≤–æ—è –Ω–æ–≤–æ–≥–æ–¥–Ω—è—è –æ—Ç–∫—Ä—ã—Ç–∫–∞ üéÑ' }
  );
});

bot.launch();
